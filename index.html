<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Notas - 1¬™ Evaluaci√≥n</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        /* Drag and Drop Zone */
        #drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            background-color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }

        #drop-zone.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
            transform: scale(1.01);
        }

        #drop-zone p {
            margin: 0;
            font-size: 1.2rem;
            color: #64748b;
        }

        #file-input {
            display: none;
        }

        /* Button */
        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Grouping UI */
        #grouping-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .group-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #f1f5f9;
            border-radius: 0.5rem;
            align-items: center;
        }

        .group-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .group-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            gap: 1rem;
            cursor: grab; /* Indicates draggable */
            transition: all 0.2s ease;
        }

        .group-item.dragging {
            opacity: 0.5;
            background-color: #f1f5f9;
        }

        .group-item.drag-over {
            background-color: #e0f2fe; /* Light blue highlight */
            border: 2px dashed var(--primary-color);
            transform: scale(1.02);
        }

        .group-item:last-child {
            border-bottom: none;
        }

        .group-item:hover {
            background-color: #f8fafc;
        }

        .original-name {
            flex: 1;
            font-family: monospace;
            color: #64748b;
        }

        .arrow-icon {
            color: #94a3b8;
        }

        /* Results Table */
        .table-container {
            overflow-x: auto;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th, td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f1f5f9;
            font-weight: 600;
            color: #475569;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        /* Stat highlights */
        .good { color: #16a34a; font-weight: bold; }
        .bad { color: #dc2626; }
        .warning { color: #d97706; }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background-color: #eff6ff;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .eval-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .eval-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìä An√°lisis de Resultados por Grupo</h1>

    <div id="drop-zone">
        <p>üìÇ Arrastra tu fichero CSV aqu√≠ o haz clic para seleccionar</p>
        <button class="btn" onclick="document.getElementById('file-input').click()">Seleccionar Fichero</button>
        <input type="file" id="file-input" accept=".csv">
    </div>

    <div id="loader" class="loader">Procesando datos...</div>

    <!-- Grouping Configuration Interface -->
    <div id="grouping-container">
        <h2>üõ†Ô∏è Configuraci√≥n de Grupos</h2>
        <p>Selecciona las unidades que quieras agrupar bajo un mismo nombre.</p>
        
        <div class="group-controls">
            <input type="text" id="bulk-group-name" placeholder="Nombre para el grupo (ej. 1¬∫ ESO)" style="flex:1; padding: 0.5rem;">
            <button class="btn" style="margin:0;" onclick="bulkGroup()">Agrupar Seleccionados</button>
        </div>

        <div class="group-list" id="group-list">
            <!-- Items injected via JS -->
        </div>

        <div style="text-align: right; margin-top: 1rem;">
            <button class="btn" onclick="calculateAndShowResults()">Ver Resultados ‚û°Ô∏è</button>
        </div>
    </div>

    <div id="results" class="table-container">
        <div style="padding: 1rem; display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
            <h2 id="year-title" style="margin:0;">Resultados</h2>
            <button class="btn" style="background-color: #64748b; font-size: 0.9rem; margin:0;" onclick="showGroupingUI()">‚öôÔ∏è Agrupar Unidades</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('section-1ev')">1¬™ Evaluaci√≥n</button>
            <button class="tab-btn" onclick="switchTab('section-2ev')">2¬™ Evaluaci√≥n</button>
            <button class="tab-btn" onclick="switchTab('section-ord')">Final (Ordinaria)</button>
            <button class="tab-btn" id="tab-ext" onclick="switchTab('section-ext')" style="display:none;">Extraordinaria</button>
        </div>

        <div id="section-1ev" class="eval-section active">
            <table id="table-1ev">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Alumnos Totales</th>
                        <th>Todo Aprobado</th>
                        <th>1 Suspenso</th>
                        <th>2 Suspensos</th>
                        <th>3 Suspensos</th>
                        <th>4+ Suspensos</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="section-2ev" class="eval-section">
            <table id="table-2ev">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Alumnos Totales</th>
                        <th>Todo Aprobado</th>
                        <th>1 Suspenso</th>
                        <th>2 Suspensos</th>
                        <th>3 Suspensos</th>
                        <th>4+ Suspensos</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="section-ord" class="eval-section">
            <table id="table-ord">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Alumnos Totales</th>
                        <th>Todo Aprobado</th>
                        <th>1 Suspenso</th>
                        <th>2 Suspensos</th>
                        <th>3 Suspensos</th>
                        <th>4+ Suspensos</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="section-ext" class="eval-section">
            <table id="table-ext">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Alumnos Totales</th>
                        <th>Todo Aprobado</th>
                        <th>1 Suspenso</th>
                        <th>2 Suspensos</th>
                        <th>3 Suspensos</th>
                        <th>4+ Suspensos</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const tableContainer = document.getElementById('results');
    const groupingContainer = document.getElementById('grouping-container');
    const groupListEl = document.getElementById('group-list');
    const loader = document.getElementById('loader');
    const yearTitle = document.getElementById('year-title');
    const tabExt = document.getElementById('tab-ext');

    let globalStudents = {}; // Stores parsed data
    let globalUnits = [];    // List of unique units found
    let academicYear = '';
    
    // Default tab
    let currentTab = 'section-1ev';

    // Drag and Drop Events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', handleFileDrop, false);
    fileInput.addEventListener('change', handleFiles, false);

    function handleFileDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files: files } });
    }

    function handleFiles(e) {
        const file = e.target.files[0];
        if (file && (file.name.endsWith('.csv') || file.name.endsWith('.CSV'))) {
            processFile(file);
        } else {
            alert('Por favor, sube un archivo CSV v√°lido.');
        }
    }

    function switchTab(sectionId) {
        // Hide all sections
        document.querySelectorAll('.eval-section').forEach(el => el.classList.remove('active'));
        // Show target
        document.getElementById(sectionId).classList.add('active');
        currentTab = sectionId;
    }

    // Add tab click listeners for styling
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(btn => {
            btn.addEventListener('click', function() {
                tabs.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
    });

    function processFile(file) {
        loader.style.display = 'block';
        tableContainer.style.display = 'none';
        groupingContainer.style.display = 'none';

        const reader = new FileReader();
        reader.readAsText(file, 'UTF-8'); 
        
        reader.onload = function(event) {
            try {
                const csvData = event.target.result;
                parseData(csvData); // Populates globalStudents and globalUnits
                renderGroupingUI(); // Prepares the UI inputs with default values
                
                // Show results immediately with default grouping (identity)
                calculateAndShowResults();
                loader.style.display = 'none';
            } catch (error) {
                console.error(error);
                alert('Error al procesar el fichero: ' + error.message);
                loader.style.display = 'none';
            }
        };
    }
    
    // New Parsing Logic
    function parseData(csvText) {
        // ... (rest of parseData is fine, no changes needed, it is huge so I will use replace on calculateAndShowResults next)
        // Wait, replace tool needs exact match. I cannot skip parseData here if I am replacing the block containing it?
        // No, I can replace just the constants block and handle events?
        // Actually, the previous tool call replaced everything UP TO processFile.
        // So parseData is intact below processFile.
        // I just need to replace the variable declaration block at the top of script (which was included in the previous replace).
        // BUT `calculateAndShowResults` is further down.
        
        // Strategy:
        // 1. I already updated `const tabExt` in the previous block?
        // Let's check the previous `new_string`.
        // "const sectionExt = document.getElementById('section-ext'); // Note: This ID is used for tab switch logic now"
        // It points to the DIV, not the TAB BUTTON.
        // I need to correct this variable reference to point to the BUTTON 'tab-ext'.
        
        // And then update calculateAndShowResults.
        
        // Let's do a targeted replace for `calculateAndShowResults` first, and redefine `sectionExt` variable.
    }
    
    // ACTUALLY, I will use a targeted replace for `calculateAndShowResults` logic.
    // And another for the variable definition if needed, or just use `document.getElementById` inside the function to be safe.
    
    // Let's replace `calculateAndShowResults` completely.

    // New Parsing Logic
    function parseData(csvText) {
        const lines = csvText.split(/\r?\n/);
        if (lines.length < 2) throw new Error('El archivo est√° vac√≠o o no tiene cabecera');

        const headers = parseCSVLine(lines[0]);
        const idxUnidad = headers.indexOf('UNIDAD');
        const idxNia = headers.indexOf('NIA');
        const idxNota1 = headers.indexOf('NOTA1EV');
        const idxNota2 = headers.indexOf('NOTA2EV');
        const idxNotaOrd = headers.indexOf('NOTAORD');
        const idxNotaLomloe = headers.indexOf('EVFINAL(LOMLOE)');
        const idxNotaExt = headers.indexOf('NOTAEXT');
        const idxEstado = headers.indexOf('ESTADO');
        const idxMateria = headers.indexOf('MATERIA_GENERAL');
        const idxAnno = headers.indexOf('C_ANNO');

        if (idxUnidad === -1 || idxNia === -1 || idxNota1 === -1) {
            throw new Error('Columnas requeridas no encontradas (UNIDAD, NIA, NOTA1EV)');
        }

        globalStudents = {};
        const unitsSet = new Set();
        academicYear = '';

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = parseCSVLine(line);
            if (cols.length < headers.length) continue;

            const nia = cols[idxNia];
            const unidad = cols[idxUnidad];
            const estado = idxEstado !== -1 ? cols[idxEstado] : 'Matriculada';
            const materia = idxMateria !== -1 ? cols[idxMateria] : '';
            
            if (!academicYear && idxAnno !== -1) academicYear = cols[idxAnno];

            if (estado !== 'Matriculada') continue;

            unitsSet.add(unidad);

            if (!globalStudents[nia]) {
                globalStudents[nia] = {
                    unidad: unidad,
                    failures1ev: 0,
                    failures2ev: 0,
                    failuresOrd: 0,
                    failuresExt: 0,
                    hasExt: false,
                    subjects: new Set()
                };
            }

            if (materia && globalStudents[nia].subjects.has(materia)) continue;
            if (materia) globalStudents[nia].subjects.add(materia);

            // Analysis for each evaluation
            const processNota = (val) => {
                if (!val) return false;
                // Clean input: remove "-M" (Matr√≠cula), replace comma.
                // "10-M" -> "10", "9-M" -> "9".
                // We also strip any other trailing text just in case for robustness, 
                // but specifically handle the requested "-M".
                let cleanVal = val.replace(',', '.').toUpperCase();
                
                // If it contains "IN" (Insuficiente) or "SB" (Sobresaliente), etc?
                // Assuming numeric 1-10 mostly. 
                // If it's pure text like "IN", parseFloat is NaN -> returns false (Pass). 
                // We should check if we need to support textual grades. 
                // For now, focusing on the "-M" numeric case.
                
                cleanVal = cleanVal.replace(/-M/g, ''); 
                
                const n = parseFloat(cleanVal);
                return (!isNaN(n) && n < 5);
            };

            if (processNota(cols[idxNota1])) globalStudents[nia].failures1ev++;
            if (idxNota2 !== -1 && processNota(cols[idxNota2])) globalStudents[nia].failures2ev++;
            
            // Final Grade Logic: Prefer NOTAORD, fallback to EVFINAL(LOMLOE)
            let valFinal = '';
            if (idxNotaOrd !== -1) valFinal = cols[idxNotaOrd];
            if ((!valFinal || valFinal.trim() === '') && idxNotaLomloe !== -1) {
                valFinal = cols[idxNotaLomloe];
            }
            if (processNota(valFinal)) globalStudents[nia].failuresOrd++;
            
            // Check Extra logic
            if (idxNotaExt !== -1) {
                const valExt = cols[idxNotaExt];
                if (valExt && valExt.trim() !== '') {
                    globalStudents[nia].hasExt = true; // Mark student as having extra grades
                    if (processNota(valExt)) globalStudents[nia].failuresExt++;
                }
            }
        }

        globalUnits = Array.from(unitsSet).sort();
    }

    // Grouping UI Logic
    function renderGroupingUI() {
        groupListEl.innerHTML = '';
        globalUnits.forEach(unit => {
            const div = document.createElement('div');
            div.className = 'group-item';
            div.setAttribute('draggable', true);
            div.dataset.unit = unit;
            
            // Drag Events
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('dragleave', handleDragLeave);
            div.addEventListener('drop', handleDrop);

            div.innerHTML = `
                <input type="checkbox" class="unit-checkbox" value="${unit}">
                <span class="original-name" style="pointer-events: none;">${unit}</span>
                <span class="arrow-icon">‚ûú</span>
                <input type="text" class="mapped-name-input" data-original="${unit}" value="${unit}" readonly style="padding: 0.3rem; border: 1px solid #cbd5e1; border-radius: 4px; background-color: #f8fafc; color: #475569; width: 200px; pointer-events: none;">
            `;
            groupListEl.appendChild(div);
        });
    }

    // Drag & Drop Handlers
    function handleDragStart(e) {
        e.dataTransfer.setData('text/plain', this.dataset.unit);
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        e.preventDefault(); // Necessary to allow dropping
        this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const sourceUnit = e.dataTransfer.getData('text/plain');
        const targetUnit = this.dataset.unit;
        
        // Don't do anything if dropping on itself
        if (sourceUnit === targetUnit) return;
        
        // Remove dragging class from all
        document.querySelectorAll('.group-item').forEach(el => el.classList.remove('dragging'));

        // 1. Calculate common name
        let commonName = getCommonPrefix(sourceUnit, targetUnit);
        
        // 2. ONLY group if there is a common part in the name
        if (commonName.length < 1) {
             console.log("No common prefix found, skipping group merge.");
             return; 
        }

        // 3. Find the *current* group names for both source and target 
        // (in case they were already renamed/grouped)
        const sourceInput = document.querySelector(`.mapped-name-input[data-original="${sourceUnit}"]`);
        const targetInput = document.querySelector(`.mapped-name-input[data-original="${targetUnit}"]`);
        
        const currentSourceGroup = sourceInput.value;
        const currentTargetGroup = targetInput.value;

        // 4. Update ALL inputs that currently match either the source's group OR the target's group
        document.querySelectorAll('.mapped-name-input').forEach(input => {
            if (input.value === currentSourceGroup || input.value === currentTargetGroup) {
                input.value = commonName;
                input.style.backgroundColor = '#dbeafe';
                setTimeout(() => input.style.backgroundColor = '#f8fafc', 500);
            }
        });
    }

    function getCommonPrefix(str1, str2) {
        let i = 0;
        while(i < str1.length && i < str2.length && str1[i] === str2[i]) {
            i++;
        }
        return str1.substring(0, i).trim();
    }

    function bulkGroup() {
        const newName = document.getElementById('bulk-group-name').value.trim();
        if (!newName) return alert('Escribe un nombre para el grupo.');
        
        const checkboxes = document.querySelectorAll('.unit-checkbox:checked');
        if (checkboxes.length === 0) return alert('Selecciona al menos una unidad.');

        checkboxes.forEach(cb => {
            const originalUnit = cb.value;
            const input = document.querySelector(`.mapped-name-input[data-original="${originalUnit}"]`);
            if (input) input.value = newName;
            cb.checked = false; // Uncheck after applying
        });
        
        document.getElementById('bulk-group-name').value = ''; // Clear input
    }

    function showGroupingUI() {
        tableContainer.style.display = 'none';
        groupingContainer.style.display = 'block';
    }

    function calculateAndShowResults() {
        // Build mapping
        const mapping = {};
        document.querySelectorAll('.mapped-name-input').forEach(input => {
            mapping[input.dataset.original] = input.value.trim() || input.dataset.original;
        });

        const stats1ev = analyzeGradesWithMapping(mapping, 'failures1ev');
        const stats2ev = analyzeGradesWithMapping(mapping, 'failures2ev');
        const statsOrd = analyzeGradesWithMapping(mapping, 'failuresOrd');
        const statsExt = analyzeGradesWithMapping(mapping, 'failuresExt', 'hasExt');
        
        renderTable('table-1ev', stats1ev);
        renderTable('table-2ev', stats2ev);
        renderTable('table-ord', statsOrd);
        renderTable('table-ext', statsExt); // Always render, just hide tab if empty
        
        if (statsExt.length > 0) {
            tabExt.style.display = 'block';
        } else {
            tabExt.style.display = 'none';
            // If we are currently viewing the extra tab (which is now hidden), switch to 1ev
            if (document.getElementById('section-ext').classList.contains('active')) {
                switchTab('section-1ev');
                document.querySelector('.tab-btn').classList.add('active'); // Activate first btn
            }
        }
        
        if (academicYear) yearTitle.innerText = `Resultados - A√±o ${academicYear}`;
        
        groupingContainer.style.display = 'none';
        tableContainer.style.display = 'block';
    }

    function analyzeGradesWithMapping(unitMapping, failureKey, requiredKey = null) {
        const groups = {}; 

        Object.values(globalStudents).forEach(student => {
            // Filter: If requiredKey is set (e.g., 'hasExt'), strictly ignore students without it
            if (requiredKey && !student[requiredKey]) {
                return;
            }

            const rawUnit = student.unidad;
            const mappedGroup = unitMapping[rawUnit] || rawUnit;

            if (!groups[mappedGroup]) {
                groups[mappedGroup] = { total: 0, pass: 0, f1: 0, f2: 0, f3: 0, f4p: 0 };
            }

            groups[mappedGroup].total++;

            const f = student[failureKey];
            if (f === 0) groups[mappedGroup].pass++;
            else if (f === 1) groups[mappedGroup].f1++;
            else if (f === 2) groups[mappedGroup].f2++;
            else if (f === 3) groups[mappedGroup].f3++;
            else groups[mappedGroup].f4p++;
        });

        return Object.keys(groups).sort().map(grpName => ({
            name: grpName,
            ...groups[grpName]
        }));
    }

    // CSV Parsing Logic
    function parseCSVLine(line) {
        const regex = /,(?=(?:(?:[^\"]*\"){2})*[^\"]*$)/; 
        return line.split(regex).map(field => field.trim().replace(/^"|"$/g, ''));
    }

    function renderTable(tableId, stats) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';
        
        stats.forEach(grp => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${grp.name}</strong></td>
                <td>${grp.total}</td>
                <td class="good">${grp.pass}</td>
                <td>${grp.f1}</td>
                <td class="warning">${grp.f2}</td>
                <td class="bad">${grp.f3}</td>
                <td class="bad" style="font-weight:bold">${grp.f4p}</td>
            `;
            tbody.appendChild(row);
        });
    }
</script>

</body>
</html>
